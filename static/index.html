<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Minimal Chat</title>
<style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

html, body {
    height: 100%;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background-color: #f2f2f2;
    color: #333;
    height: 100vh;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}


#header {
    padding: 16px 12px;
    text-align: center;
    background-color: #e0e0e0;
    font-weight: 600;
    flex-shrink: 0;
    font-size: 16px;
}


#messages {
    flex: 1 1 auto;
    padding: 12px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 60px;
}

.message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 16px;
    word-wrap: break-word;
    font-size: 15px;
    line-height: 1.4;
    word-break: break-word;
}

.message .username {
    font-weight: 600;
    font-size: 13px;
    opacity: 0.8;
    margin-bottom: 4px;
}

.sent {
    align-self: flex-end;
    background-color: #d0ebff;
    color: #003366;
    border-bottom-right-radius: 4px;
}

.received {
    align-self: flex-start;
    background-color: #e6e6e6;
    color: #333;
    border-bottom-left-radius: 4px;
}

#input-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    display: flex;
    padding: 8px 12px;
    background-color: #e0e0e0;
    gap: 8px;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
}

#input-bar input[type="text"] {
    flex: 1;
    padding: 12px 16px;
    border-radius: 24px;
    border: none;
    outline: none;
    font-size: 16px;
    background-color: #fff;
}

#input-bar button {
    padding: 12px 20px;
    border: none;
    border-radius: 24px;
    background-color: #007bff;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.2s;
}

#input-bar button:hover {
    background-color: #0056b3;
}

#messages::-webkit-scrollbar {
    width: 6px;
}

#messages::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.2);
    border-radius: 3px;
}


@media (max-width: 480px) {
    #header {
        font-size: 14px;
        padding: 12px 8px;
    }
    .message {
        font-size: 14px;
        padding: 10px 14px;
    }
    #input-bar input[type="text"] {
        font-size: 14px;
        padding: 10px 14px;
    }
    #input-bar button {
        font-size: 14px;
        padding: 10px 14px;
    }
}
</style>
</head>
<body>

<div id="header">
    Hello <span id="name">Loading...</span>!
</div>

<div id="messages">
    <!-- messages -->
</div>

<div id="input-bar">
    <input type="text" id="text" placeholder="Type a message...">
    <button onclick="send()">Send</button>
</div>

<script>
function get_username() {
    let name = "";
    do {
        name = prompt("Enter your username (required):");
        if (name === null) return "Stranger";
        name = name.trim();
    } while (name === "");
    return name;
}

const n = document.getElementById("name");
const username = get_username();
n.textContent = username;

const messagesDiv = document.getElementById('messages');
const textInput = document.getElementById("text");

const eventSource = new EventSource('api/v1/events');

eventSource.onmessage = (event) => {
    let message = JSON.parse(event.data);

    const messageEl = document.createElement('div');
    messageEl.classList.add('message');
    messageEl.classList.add(message.username === username ? 'sent' : 'received');

    const nameEl = document.createElement('div');
    nameEl.classList.add('username');
    nameEl.textContent = message.username;

    const textEl = document.createElement('div');
    textEl.textContent = message.text;

    messageEl.appendChild(nameEl);
    messageEl.appendChild(textEl);
    messagesDiv.appendChild(messageEl);

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
};

eventSource.onerror = (err) => {
    console.error("SSE error:", err);
};

textInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") send();
});

function send() {
    let message = textInput.value.trim();
    if (message.length > 0) {
        fetch("/api/v1/send", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, text: message }),
        });
        textInput.value = "";
    }
}
</script>

</body>
</html>
